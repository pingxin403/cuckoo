# IM 聊天功能快速启动指南

## 🚀 快速开始

### 1. 启动 IM Gateway 服务

```bash
cd apps/im-gateway-service
go run main.go
```

确保服务运行在 `ws://localhost:8080/ws`

### 2. 启动 Web 前端

```bash
cd apps/web
npm install  # 如果还没安装依赖
npm run dev
```

访问 http://localhost:5173

### 3. 使用聊天功能

1. 点击页面顶部的 **"IM 聊天"** Tab
2. 查看连接状态（应显示绿色圆点 + "已连接"）
3. 选择接收者类型（私聊/群聊）
4. 输入接收者 ID（例如：`user456`）
5. 输入消息内容
6. 点击 **"发送"** 按钮

## 🧪 测试多用户聊天

### 方法 1: 多个浏览器标签页

1. 打开 2-3 个浏览器标签页
2. 每个标签页都会自动连接（使用相同的 Mock Token）
3. 在标签页 A 中发送消息给 `user456`
4. 在标签页 B 中应该实时收到消息

### 方法 2: 不同浏览器

1. 在 Chrome 中打开应用
2. 在 Firefox 中打开应用
3. 互相发送消息测试

## 📋 功能说明

### 连接状态指示器

- 🟢 **绿色圆点 + "已连接"**: WebSocket 连接正常
- 🟡 **黄色圆点 + "连接中..."**: 正在建立连接
- 🔴 **红色圆点 + "未连接"**: 连接断开

### 消息状态

发送的消息会显示状态：

- **发送中...** (灰色): 消息正在发送
- **已发送** (深灰): 服务器已接收
- **已送达** (绿色): 对方已收到
- **已读** (蓝色): 对方已查看

### 重连机制

如果连接断开，系统会自动重连：

- 显示重连进度：`重连中 (1/5)`
- 使用指数退避策略：1s → 2s → 4s → 8s → 16s → 30s
- 最多尝试 5 次

## 🔧 配置说明

### 环境变量

**开发环境** (`.env.development`):
```env
VITE_IM_GATEWAY_WS_URL=ws://localhost:8080/ws
VITE_DEBUG=true
```

**生产环境** (`.env.production`):
```env
VITE_IM_GATEWAY_WS_URL=wss://your-domain.com/ws
VITE_DEBUG=false
```

### 存储策略

- **开发环境**: Memory 存储（快速，不持久化）
- **生产环境**: IndexedDB 存储（50MB+，持久化）

## 🐛 故障排查

### 问题 1: 无法连接

**症状**: 显示"未连接"或"连接中..."

**解决方案**:
1. 检查 IM Gateway 是否运行：`curl http://localhost:8080/health`
2. 检查 WebSocket 端点：`ws://localhost:8080/ws`
3. 查看浏览器控制台错误信息

### 问题 2: 消息发送失败

**症状**: 消息状态显示"发送失败"

**解决方案**:
1. 检查连接状态是否为"已连接"
2. 检查接收者 ID 是否正确
3. 查看浏览器控制台错误信息

### 问题 3: 收不到消息

**症状**: 对方发送的消息没有显示

**解决方案**:
1. 确认两个客户端都已连接
2. 检查接收者 ID 是否匹配
3. 刷新页面重新连接

## 📚 更多信息

### SDK 文档
- `src/sdk/im-client/README.md` - 完整 SDK 文档
- `src/sdk/im-client/example.ts` - 使用示例

### API 文档
- `apps/im-gateway-service/API.md` - WebSocket 协议文档

### 完成报告
- `.kiro/specs/im-chat-system/TASK_22.2_COMPLETION.md` - 详细实现报告
- `.kiro/specs/im-chat-system/PHASE_7_STATUS.md` - Phase 7 状态

## 🎯 下一步

### 可选功能（未实现）

1. **离线消息同步** (Task 22.3)
   - 连接时自动获取离线消息
   - 显示离线消息数量

2. **可复用 UI 组件** (Task 22.1)
   - 独立的消息列表组件
   - 独立的输入框组件
   - 用户/群组列表组件

3. **前端测试** (Task 22.4)
   - SDK 单元测试
   - 组件测试
   - 集成测试

### 生产环境部署

1. **认证集成**
   - 替换 Mock Token
   - 集成真实的认证系统
   - 实现 Token 刷新

2. **配置更新**
   - 更新 `.env.production` 中的 Gateway URL
   - 配置 CDN/Nginx

3. **监控和日志**
   - 添加错误追踪
   - 添加性能监控
   - 添加用户行为分析

## 💡 提示

- 当前使用 **Mock Token** 进行演示
- 所有标签页共享相同的用户身份
- 生产环境需要集成真实的认证系统
- 消息去重 TTL 为 7 天
- 心跳间隔为 30 秒

---

**状态**: ✅ 功能完整，可以使用！  
**版本**: 1.0.0  
**更新时间**: 2026-01-25
